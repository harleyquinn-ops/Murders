<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Murders - Painel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: Poppins, sans-serif;
    background: #f1f5f9;
    color: #020617;
    display: flex;
    min-height: 100vh;
  }

  .sidebar {
    width: 250px;
    background: #0f172a;
    color: white;
    padding: 20px;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
  }
  .sidebar h2 { margin-bottom: 30px; font-weight: 600; }

  .clan-btn {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: none;
    background: #1e293b;
    color: white;
    cursor: pointer;
    border-radius: 999px;
    font-family: Poppins, sans-serif;
    font-weight: 500;
  }
  .clan-btn.active { background: #38bdf8; color: #020617; }
  .clan-btn:hover { background: #0ea5e9; }

  .sidebar hr { margin: 20px 0; border: none; border-top: 1px solid #1f2937; }

  .tab-btn {
    width: 100%;
    padding: 10px 14px;
    margin: 4px 0;
    border: none;
    background: transparent;
    color: #e5e7eb;
    cursor: pointer;
    border-radius: 999px;
    font-family: Poppins, sans-serif;
    text-align: left;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab-btn span.icon {
    width: 22px;
    text-align: center;
  }
  .tab-btn.active {
    background: #38bdf8;
    color: #020617;
    font-weight: 600;
  }
  .tab-btn:hover {
    background: #0ea5e9;
    color: #020617;
  }

  .main {
    margin-left: 250px;
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: #e2f3ff;
  }

  .header {
    background: #ffffff;
    padding: 18px 22px;
    border-radius: 16px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 8px 24px rgba(15,23,42,0.08);
    color: #020617;
  }
  .header h1 { font-size: 22px; color: #020617; display:flex; align-items:center; gap:8px; }
  .header-sub {
    color: #6b7280;
    font-size: 13px;
    margin-top: 4px;
  }

  .card {
    background: #ffffff;
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 15px;
    box-shadow: 0 6px 20px rgba(15,23,42,0.06);
    border: 1px solid #e5e7eb;
    color: #020617;
  }
  .card h3 { color: #020617; margin-bottom: 8px; font-size: 15px; }
  .card p { font-size: 12px; color: #6b7280; margin-bottom: 12px; }

  .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
  .btn {
    padding: 8px 14px;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    font-size: 12px;
    font-family: Poppins, sans-serif;
    font-weight: 500;
    transition: all 0.15s;
  }
  .btn-primary { background: #38bdf8; color: #020617; }
  .btn-primary:hover { background: #0ea5e9; transform: translateY(-1px); }
  .btn-danger { background: #ef4444; color: white; }
  .btn-danger:hover { background: #b91c1c; }
  .btn-secondary { background: #0f172a; color: #e5e7eb; }
  .btn-secondary:hover { background: #1e293b; }

  .input-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; align-items: flex-end; }
  .input, select, textarea {
    padding: 8px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 999px;
    font-family: Poppins, sans-serif;
    font-size: 12px;
    background: #ffffff;
    color: #020617;
  }
  .input { flex: 1; min-width: 150px; }
  select { flex: 0.5; min-width: 120px; border-radius: 999px; }
  textarea {
    width: 100%;
    min-height: 80px;
    resize: vertical;
    border-radius: 18px;
  }
  .input::placeholder { color: #9ca3af; }

  .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e5e7eb; background:#ffffff; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; color:#020617; }
  table thead { background: #eff6ff; position: sticky; top: 0; }
  table th, table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
  }
  table th { font-weight: 600; color:#1e293b; font-size:11px; text-transform:uppercase; letter-spacing:0.05em; }
  table tbody tr:hover { background: #f9fafb; }

  .modal {
    display: none !important;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(15,23,42,0.35);
    z-index: 1000;
    overflow-y: auto;
  }
  .modal.active {
    display: flex !important;
    align-items: flex-start;
    justify-content: center;
    padding-top: 20px;
  }
  .modal-content {
    background: #ffffff;
    padding: 24px 22px;
    border-radius: 18px;
    width: 90%;
    max-width: 480px;
    margin-bottom: 20px;
    box-shadow: 0 16px 40px rgba(15,23,42,0.18);
    border: 1px solid #e5e7eb;
    color:#020617;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h2 { font-size: 17px; color: #020617; }
  .close-btn {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: #6b7280;
  }
  .close-btn:hover { color:#020617; }

  .form-group { margin-bottom: 12px; }
  .form-group label {
    display: block;
    font-size: 12px;
    margin-bottom: 4px;
    font-weight: 600;
    color: #0f172a;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid #cbd5e1;
    background:#ffffff;
    color:#020617;
  }
  .form-group textarea { border-radius: 16px; }

  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  .tab { display: none; }
  .tab.active { display: block; }

  .empty { text-align: center; color: #6b7280; padding: 20px; }

  .success {
    background: #ecfdf3;
    color: #166534;
    padding: 10px;
    border-radius: 999px;
    margin-bottom: 15px;
    border:1px solid #bbf7d0;
    font-size:12px;
  }
  .error {
    background: #fef2f2;
    color: #b91c1c;
    padding: 10px;
    border-radius: 999px;
    margin-bottom: 15px;
    border:1px solid #fecaca;
    font-size:12px;
  }

  @media (max-width: 768px) {
    .sidebar { width: 100%; height: auto; position: relative; }
    .main { margin-left: 0; }
  }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>‚öîÔ∏è Murders</h2>
    <button class="clan-btn active" onclick="setClan(1)" data-clan="1">Clan 1</button>
    <button class="clan-btn" onclick="setClan(2)" data-clan="2">Clan 2</button>
    <hr>
    <button class="tab-btn active" onclick="switchTab('members')" data-tab="members">
      <span class="icon">üë•</span> Membros
    </button>
    <button class="tab-btn" onclick="switchTab('events')" data-tab="events">
      <span class="icon">üìä</span> Presen√ßa
    </button>
    <button class="tab-btn" onclick="switchTab('deliveries')" data-tab="deliveries">
      <span class="icon">üì¶</span> Entregas
    </button>
    <button class="tab-btn" onclick="switchTab('repo')" data-tab="repo">
      <span class="icon">üìÇ</span> Reposit√≥rio
    </button>
    <button class="tab-btn" onclick="switchTab('reports')" data-tab="reports">
      <span class="icon">üìà</span> Relat√≥rios
    </button>
    <button class="tab-btn" onclick="switchTab('settings')" data-tab="settings">
      <span class="icon">‚öôÔ∏è</span> Configura√ß√µes
    </button>
  </div>

  <div class="main">
    <div class="header">
      <div>
        <h1 id="pageTitle"><span id="pageIcon">üë•</span> Membros do cl√£</h1>
        <p class="header-sub">Cl√£ <span id="clanDisplay">1</span> ‚Ä¢ Gerenciamento r√°pido de membros, presen√ßa, entregas e estoque</p>
      </div>
      <button class="btn btn-secondary" onclick="toggleTheme()">üåô Tema</button>
    </div>

    <div id="msgContainer"></div>

    <!-- CONFIGURA√á√ïES -->
    <div class="tab" id="tab-settings">
      <div class="card">
        <h3>Configura√ß√µes gerais</h3>
        <p>Ajuste integra√ß√µes e importa√ß√µes. As a√ß√µes sempre valem para o cl√£ selecionado.</p>

        <div class="card" style="margin-bottom:14px;">
          <h3>Importar / Exportar dados</h3>
          <p>Importa membros ou reposit√≥rio automaticamente, conforme o arquivo.</p>
          <div class="btn-row">
            <button class="btn btn-secondary" type="button" onclick="clickImportJSON()">üì• Importar JSON</button>
            <button class="btn btn-primary" type="button" onclick="exportJSON()">üì§ Exportar JSON</button>
            <button class="btn btn-secondary" type="button" onclick="exportPDF()">üñ®Ô∏è Exportar PDF da aba atual</button>
          </div>
          <input type="file" id="json-file-input" accept=".json,application/json" style="display:none">
        </div>

        <div class="card" style="margin-bottom:14px;">
          <h3>Colar reposit√≥rio (texto do jogo)</h3>
          <p>Cole direto aqui a listagem do jogo, como aquele bloco que voc√™ me mandou, e converto em itens.</p>
          <div class="form-group">
            <label>Texto copiado</label>
            <textarea id="pasteRepoText" placeholder="Cole aqui o texto do jogo..."></textarea>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="parsePastedRepo()">üîÑ Converter e salvar</button>
          </div>
        </div>

        <div class="card">
          <h3>Webhooks do Discord - Cl√£ <span id="webhookClanDisplay">1</span></h3>
          <p>Configure webhooks diferentes para cada cl√£ e tipo de relat√≥rio.</p>

          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #0f172a; display: block; margin-bottom: 4px;">Webhook - Membros</label>
            <div class="input-row">
              <input id="webhookUrl-members" class="input" placeholder="URL do webhook para membros..." style="flex: 1;">
              <button class="btn btn-primary" onclick="saveWebhook('members')">Salvar</button>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #0f172a; display: block; margin-bottom: 4px;">Webhook - Presen√ßa</label>
            <div class="input-row">
              <input id="webhookUrl-events" class="input" placeholder="URL do webhook para presen√ßa..." style="flex: 1;">
              <button class="btn btn-primary" onclick="saveWebhook('events')">Salvar</button>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #0f172a; display: block; margin-bottom: 4px;">Webhook - Entregas</label>
            <div class="input-row">
              <input id="webhookUrl-deliveries" class="input" placeholder="URL do webhook para entregas..." style="flex: 1;">
              <button class="btn btn-primary" onclick="saveWebhook('deliveries')">Salvar</button>
            </div>
          </div>
          
          <div>
            <label style="font-size: 12px; font-weight: 600; color: #0f172a; display: block; margin-bottom: 4px;">Webhook - Reposit√≥rio</label>
            <div class="input-row">
              <input id="webhookUrl-repo" class="input" placeholder="URL do webhook para reposit√≥rio..." style="flex: 1;">
              <button class="btn btn-primary" onclick="saveWebhook('repo')">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Membros -->
    <div class="tab active" id="tab-members">
      <div class="card">
        <h3>Membros do cl√£</h3>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openMemberModal()">‚ûï Novo membro</button>
          <button class="btn btn-danger" onclick="clearAllMembers()">üóëÔ∏è Apagar todos</button>
          <button class="btn btn-secondary" onclick="sendDiscordMembers()">üí¨ Enviar para Discord</button>
        </div>
        <div class="input-row">
          <input id="searchMembers" class="input" placeholder="üîç Buscar nick..." oninput="renderMembers()" style="flex: 1;">
          <select id="filterClass" onchange="renderMembers()">
            <option value="">Todas as classes</option>
            <option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Nick</th><th>Level</th><th>Power</th><th>Classe</th><th>Data</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="members-body"><tr><td colspan="6" class="empty">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Presen√ßa -->
    <div class="tab" id="tab-events">
      <div class="card">
        <h3>Presen√ßa em eventos</h3>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openEventModal()">‚ûï Novo evento</button>
          <button class="btn btn-danger" onclick="clearAllEvents()">üóëÔ∏è Apagar tudo</button>
          <button class="btn btn-secondary" onclick="sendDiscordEvents()">üí¨ Enviar para Discord</button>
        </div>
        <div class="input-row">
          <select id="filterEvent" onchange="renderEvents()">
            <option value="">Todos eventos</option><option>Boss do cl√£</option><option>Copa Ymir</option><option>Guerra da coroa</option><option>Ilha de Sindri</option><option>Interserver</option>
          </select>
          <select id="filterStatus" onchange="renderEvents()">
            <option value="">Todos status</option><option>Presente</option><option>Faltou</option><option>Justificou</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Data</th><th>Nick</th><th>Evento</th><th>Status</th><th>Justificativa</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="events-body"><tr><td colspan="6" class="empty">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Entregas -->
    <div class="tab" id="tab-deliveries">
      <div class="card">
        <h3>Entregas do cl√£</h3>
        <div class="btn-row">
          <button class="btn btn-primary" onclick="openDeliveryModal()">‚ûï Registrar entrega</button>
          <button class="btn btn-secondary" onclick="showMonthlyReport()">üìã Relat√≥rio mensal</button>
          <button class="btn btn-secondary" onclick="sendDiscordDeliveries()">üí¨ Enviar para Discord</button>
        </div>
        <div class="input-row">
          <input id="searchDeliveriesNick" class="input" placeholder="üîç Buscar nick..." oninput="renderDeliveries()" style="flex: 1;">
          <select id="filterDeliveriesClass" onchange="renderDeliveries()">
            <option value="">Todas as classes</option><option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
          </select>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Data</th><th>Nick</th><th>Classe</th><th>Descri√ß√£o</th><th>Qtd</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="deliveries-body"><tr><td colspan="6" class="empty">Carregando...</td></tr></tbody>
          </table>
        </div>
        <div class="card" id="monthly-report-card" style="margin-top:14px; display:none;">
          <h3>Relat√≥rio mensal</h3>
          <div class="input-row">
            <input type="month" class="input" id="reportMonth" onchange="renderMonthlyReport()">
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Nick</th><th>Resumo</th></tr></thead>
              <tbody id="monthly-report-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Reposit√≥rio -->
    <div class="tab" id="tab-repo">
      <div class="card">
        <h3>Reposit√≥rio</h3>
        <div class="card" style="margin-bottom:10px;">
          <h3>Novo item</h3>

          <div class="form-group">
            <label>Descri√ß√£o</label>
            <input id="repoItem" class="input" placeholder="Nome do item">
          </div>

          <div class="form-group">
            <label>Tipo</label>
            <input id="repoType" class="input" placeholder="Tipo">
          </div>

          <div class="form-group">
            <label>Boss / origem</label>
            <input id="repoBoss" class="input" placeholder="Boss / origem">
          </div>

          <div class="form-group">
            <label>Quantidade</label>
            <input id="repoQuantity" class="input" type="number" placeholder="Qtd">
          </div>

          <div class="btn-row" style="margin-top:8px;">
            <button class="btn btn-primary" onclick="addRepoItem()">Salvar</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr><th>Item</th><th>Tipo</th><th>Boss</th><th>Qtd</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="repo-body"><tr><td colspan="5" class="empty">Nenhum item</td></tr></tbody>
          </table>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button class="btn btn-danger" onclick="clearRepo()">üóëÔ∏è Limpar reposit√≥rio</button>
          <button class="btn btn-secondary" onclick="sendDiscordRepo()">üí¨ Enviar para Discord</button>
        </div>
      </div>
    </div>

    <!-- Relat√≥rios -->
    <div class="tab" id="tab-reports">
      <div class="card">
        <h3>Relat√≥rios</h3>
        <p>Espa√ßo reservado para resumos mais avan√ßados.</p>
      </div>
    </div>
  </div>

  <!-- MODAIS -->
  <div class="modal" id="member-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Membro</h2>
        <button class="close-btn" onclick="closeModal('member-modal')">‚úï</button>
      </div>
      <input type="hidden" id="member-index">
      <div class="form-group">
        <label>Nick</label>
        <input id="member-nick" class="input">
      </div>
      <div class="form-group">
        <label>Level</label>
        <input id="member-level" class="input" type="number">
      </div>
      <div class="form-group">
        <label>Power</label>
        <input id="member-power" class="input">
      </div>
      <div class="form-group">
        <label>Classe</label>
        <select id="member-class" class="input">
          <option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
        </select>
      </div>
      <div class="form-group">
        <label>Data (dd/mm/aaaa)</label>
        <input id="member-date" class="input">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('member-modal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveMember()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="event-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Evento</h2>
        <button class="close-btn" onclick="closeModal('event-modal')">‚úï</button>
      </div>
      <input type="hidden" id="event-index">
      <div class="form-group">
        <label>Data (dd/mm/aaaa)</label>
        <input id="event-date" class="input">
      </div>
      <div class="form-group">
        <label>Evento</label>
        <select id="event-name" class="input">
          <option>Boss do cl√£</option><option>Copa Ymir</option><option>Guerra da coroa</option><option>Ilha de Sindri</option><option>Interserver</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nick</label>
        <select id="event-nick" class="input"></select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="event-status" class="input">
          <option>Presente</option><option>Faltou</option><option>Justificou</option>
        </select>
      </div>
      <div class="form-group">
        <label>Justificativa</label>
        <input id="event-just" class="input">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('event-modal')">Fechar</button>
        <button class="btn btn-primary" onclick="saveEvent()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="delivery-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Entrega</h2>
        <button class="close-btn" onclick="closeModal('delivery-modal')">‚úï</button>
      </div>
      <input type="hidden" id="delivery-index">
      <div class="form-group">
        <label>Data (dd/mm/aaaa)</label>
        <input id="delivery-date" class="input">
      </div>
      <div class="form-group">
        <label>Nick</label>
        <select id="delivery-nick" class="input"></select>
      </div>
      <div class="form-group">
        <label>Classe</label>
        <select id="delivery-class" class="input">
          <option>Arqueira</option><option>Bardo</option><option>Berserker</option><option>Lanceiro</option><option>Maga</option><option>Mago</option>
        </select>
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <input id="delivery-desc" class="input" list="delivery-items">
        <datalist id="delivery-items"></datalist>
      </div>
      <div class="form-group">
        <label>Quantidade</label>
        <input id="delivery-qtd" class="input" type="number" min="1" value="1">
      </div>
      <div class="form-group">
        <label>Observa√ß√£o</label>
        <input id="delivery-obs" class="input">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('delivery-modal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveDelivery()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'murders_painel_v9';
    const API_BASE = 'http://localhost:3000/api';

    let state = {
      clan: 1,
      webhooks: { 
        1: { members: '', events: '', deliveries: '', repo: '' },
        2: { members: '', events: '', deliveries: '', repo: '' }
      },
      members: { 1: [], 2: [] },
      events: { 1: [], 2: [] },
      deliveries: { 1: [], 2: [] },
      repoItems: { 1: [], 2: [] }
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function showMessage(msg, type = 'success') {
      const container = document.getElementById('msgContainer');
      container.innerHTML = `<div class="${type}">${msg}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 3000);
    }

    function toISOFromBR(brDate) {
      if (!brDate) return '';
      const parts = brDate.split('/');
      if (parts.length !== 3) return '';
      const [d, m, y] = parts;
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    function toBRFromISO(isoDate) {
      if (!isoDate) return '';
      const [y, m, d] = isoDate.split('-');
      if (!y || !m || !d) return '';
      return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
    }

    function toBRDayMonthFromISO(isoDate) {
      if (!isoDate) return '';
      const d = new Date(isoDate);
      if (Number.isNaN(d.getTime())) return '';
      const dia = String(d.getDate()).padStart(2,'0');
      const mes = String(d.getMonth() + 1).padStart(2,'0');
      return `${dia}/${mes}`;
    }

    function todayBR() {
      const now = new Date();
      return `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
    }

    async function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const saved = JSON.parse(raw);
          if (saved.webhooks) state.webhooks = saved.webhooks;
          if (saved.clan) state.clan = saved.clan;
          if (saved.members) state.members = saved.members;
          if (saved.events) state.events = saved.events;
          if (saved.deliveries) state.deliveries = saved.deliveries;
          if (saved.repoItems) state.repoItems = saved.repoItems;
        }
      } catch (e) {
        console.error('Erro ao carregar localStorage:', e);
      }

      document.getElementById('clanDisplay').textContent = state.clan;
      document.getElementById('webhookClanDisplay').textContent = state.clan;

      if (state.webhooks && state.webhooks[state.clan]) {
        document.getElementById('webhookUrl-members').value = state.webhooks[state.clan].members || '';
        document.getElementById('webhookUrl-events').value = state.webhooks[state.clan].events || '';
        document.getElementById('webhookUrl-deliveries').value = state.webhooks[state.clan].deliveries || '';
        document.getElementById('webhookUrl-repo').value = state.webhooks[state.clan].repo || '';
      }

      await loadAllFromAPI();
    }

    async function loadAllFromAPI() {
      await Promise.all([
        loadMembersFromAPI(),
      ]);
      renderEvents();
      renderDeliveries();
      renderRepo();
      fillDeliveryItemOptions();
    }

    async function loadMembersFromAPI() {
      try {
        const res = await fetch(`${API_BASE}/members?clan=${state.clan}`);
        if (!res.ok) throw new Error('Erro ao carregar membros');
        const data = await res.json();
        state.members[state.clan] = data;
        renderMembers();
        fillEventNickOptions();
        fillDeliveryNickOptions();
        fillDeliveryItemOptions();
      } catch (err) {
        console.error(err);
        showMessage('‚ùå Erro ao carregar membros da API', 'error');
      }
    }

    function setClan(clan) {
      state.clan = clan;
      document.querySelectorAll('.clan-btn').forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.clan) === clan);
      });
      document.getElementById('clanDisplay').textContent = clan;
      document.getElementById('webhookClanDisplay').textContent = clan;
      
      if (state.webhooks && state.webhooks[clan]) {
        document.getElementById('webhookUrl-members').value = state.webhooks[clan].members || '';
        document.getElementById('webhookUrl-events').value = state.webhooks[clan].events || '';
        document.getElementById('webhookUrl-deliveries').value = state.webhooks[clan].deliveries || '';
        document.getElementById('webhookUrl-repo').value = state.webhooks[clan].repo || '';
      }
      
      loadAllFromAPI();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.querySelectorAll('.tab').forEach(sec => {
        const isActive = sec.id === 'tab-' + tab;
        sec.classList.toggle('active', isActive);
        sec.style.display = isActive ? 'block' : 'none';
      });

      const titles = {
        members: { icon:'üë•', text:'Membros' },
        events: { icon:'üìä', text:'Presen√ßa' },
        deliveries: { icon:'üì¶', text:'Entregas' },
        repo: { icon:'üìÇ', text:'Reposit√≥rio' },
        reports: { icon:'üìà', text:'Relat√≥rios' },
        settings: { icon:'‚öôÔ∏è', text:'Configura√ß√µes' }
      };
      const info = titles[tab] || { icon:'üë•', text:'Painel' };
      document.getElementById('pageTitle').innerHTML = `<span id="pageIcon">${info.icon}</span> ${info.text} do cl√£`;
    }

    function toggleTheme() {
      const current = document.body.dataset.theme || 'light';
      const next = current === 'light' ? 'dark' : 'light';
      document.body.dataset.theme = next;

      if (next === 'dark') {
        document.body.style.background = '#0f172a';
      } else {
        document.body.style.background = '#f1f5f9';
      }
    }

    function saveWebhook(type) {
      const value = document.getElementById('webhookUrl-' + type).value.trim();
      if (!state.webhooks[state.clan]) state.webhooks[state.clan] = {};
      state.webhooks[state.clan][type] = value;
      saveState();
      showMessage('‚úÖ Webhook salvo!', 'success');
    }

    function enviarDiscord(webhookUrl, payload) {
      fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => {
        if (res.ok) {
          showMessage('‚úÖ Enviado para Discord!', 'success');
        } else {
          showMessage('‚ùå Erro: ' + res.status, 'error');
        }
      })
      .catch(() => {
        showMessage('‚ùå Erro na conex√£o', 'error');
      });
    }

    function sendDiscordMembers() {
      const url = state.webhooks[state.clan]?.members;
      if (!url) { showMessage('‚ö†Ô∏è Configure webhook de membros', 'error'); return; }

      const members = state.members[state.clan] || [];
      const description =
        members.length === 0
          ? "_Nenhum membro registrado._"
          : members
              .map(m => `‚Ä¢ **${m.nick}** ‚Äî N√≠vel ${m.level ?? ''} | Power ${m.power != null ? Number(m.power).toLocaleString('pt-BR') : ''} | Classe: ${m.classe ?? ''}`)
              .join("\n");

      const payload = {
        embeds: [{
          title: "üë• Membros - Clan " + state.clan,
          description,
          color: 0x3498db
        }]
      };

      enviarDiscord(url, payload);
    }

    function sendDiscordEvents() {
      const url = state.webhooks[state.clan]?.events;
      if (!url) { showMessage('‚ö†Ô∏è Configure webhook de presen√ßa', 'error'); return; }

      const events = state.events[state.clan] || [];
      const description =
        events.length === 0
          ? "_Nenhum evento registrado._"
          : events.map(e => {
              const icon =
                e.status === "Presente" ? "‚úÖ" :
                e.status === "Faltou"   ? "‚ùå" :
                                          "üü°";
              let line = `‚Ä¢ **${e.nick}** ‚Äî ${e.evento} ${icon} (${e.status})`;
              if (e.justificativa && e.justificativa.trim() !== "") {
                line += ` ‚Äî _${e.justificativa}_`;
              }
              return line;
            }).join("\n");

      const payload = {
        embeds: [{
          title: "üóìÔ∏è Presen√ßa - Clan " + state.clan,
          description,
          color: 0xf1c40f
        }]
      };

      enviarDiscord(url, payload);
    }

    function sendDiscordDeliveries() {
      const url = state.webhooks[state.clan]?.deliveries;
      if (!url) { showMessage('‚ö†Ô∏è Configure webhook de entregas', 'error'); return; }

      const deliveries = state.deliveries[state.clan] || [];
      const description =
        deliveries.length === 0
          ? "_Nenhuma entrega registrada._"
          : deliveries
              .map(d => `‚Ä¢ **${d.nick}** (${d.classe}) ‚Äî ${d.descricao} (x${d.qtd || 1})`)
              .join("\n");

      const payload = {
        embeds: [{
          title: "üì¶ Entregas - Clan " + state.clan,
          description,
          color: 0x2ecc71
        }]
      };

      enviarDiscord(url, payload);
    }

    function sendDiscordRepo() {
      const url = state.webhooks[state.clan]?.repo;
      if (!url) { showMessage('‚ö†Ô∏è Configure webhook de reposit√≥rio', 'error'); return; }

      const items = state.repoItems[state.clan] || [];
      const description =
        items.length === 0
          ? "_Nenhum item no reposit√≥rio._"
          : items.map(r =>
              `‚Ä¢ **${r.item}** ‚Äî Qtd: ${r.qtd}` +
              (r.boss ? ` | Boss: ${r.boss}` : "") +
              (r.tipo ? ` | Tipo: ${r.tipo}` : "")
            ).join("\n");

      const payload = {
        embeds: [{
          title: "üìö Reposit√≥rio - Clan " + state.clan,
          description,
          color: 0x9b59b6
        }]
      };

      enviarDiscord(url, payload);
    }

    function clickImportJSON() {
      document.getElementById('json-file-input').onchange = handleJSONFile;
      document.getElementById('json-file-input').click();
    }

    function handleJSONFile(evt) {
      const file = evt.target.files && evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          
          if (Array.isArray(imported) && imported.length > 0) {
  if (imported[0].nick !== undefined && imported[0].nome === undefined) {
    state.members[state.clan] = imported;
    saveState();
    renderMembers();
    fillEventNickOptions();
    fillDeliveryNickOptions();
    showMessage(`‚úÖ ${imported.length} membros importados!`, 'success');
    return;
  }
}

            
            if (imported[0].nick !== undefined && imported[0].nome === undefined) {
              state.members[state.clan] = imported;
              saveState();
              renderMembers();
              fillEventNickOptions();
              fillDeliveryNickOptions();
              showMessage(`‚úÖ ${imported.length} membros importados!`, 'success');
              return;
            }
          
          
          if (imported.repoItems && Array.isArray(imported.repoItems)) {
            state.repoItems[state.clan] = imported.repoItems;
            saveState();
            renderRepo();
            fillDeliveryItemOptions();
            showMessage(`‚úÖ ${imported.repoItems.length} itens importados!`, 'success');
            return;
          }
          
          if (imported.members && imported.events && imported.deliveries && imported.repoItems) {
  // mescla por cl√£, n√£o joga fora o outro
  if (imported.members[1]) state.members[1] = imported.members[1];
  if (imported.members[2]) state.members[2] = imported.members[2];

  if (imported.events[1]) state.events[1] = imported.events[1];
  if (imported.events[2]) state.events[2] = imported.events[2];

  if (imported.deliveries[1]) state.deliveries[1] = imported.deliveries[1];
  if (imported.deliveries[2]) state.deliveries[2] = imported.deliveries[2];

  if (imported.repoItems[1]) state.repoItems[1] = imported.repoItems[1];
  if (imported.repoItems[2]) state.repoItems[2] = imported.repoItems[2];

  saveState();
  renderAll();
  showMessage('‚úÖ Dados importados e mesclados por cl√£!', 'success');
  return;
}

          
          showMessage('‚ùå Formato de arquivo n√£o reconhecido!', 'error');
        } catch (err) {
          showMessage('‚ùå Erro ao ler arquivo: ' + err.message, 'error');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function exportJSON() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `murders-clan${state.clan}-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showMessage('‚úÖ Exportado!', 'success');
    }

    function exportPDF() {
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        const w = window.open('', '_blank');
        w.document.write(`<html><body>${activeTab.innerHTML}</body></html>`);
        w.print();
      }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // PARSE do texto do jogo para reposit√≥rio
    function parsePastedRepo() {
      const raw = (document.getElementById('pasteRepoText').value || '').trim();
      if (!raw) {
        showMessage('‚ùå Cole o texto do reposit√≥rio primeiro', 'error');
        return;
      }

      const lines = raw.split('\n')
        .map(l => l.trim())
        .filter(l => l);

      if (!lines.length) {
        showMessage('‚ùå N√£o encontrei linhas v√°lidas', 'error');
        return;
      }

      const repo = [];

      for (const line of lines) {
        // formato: NOMEITEMQTDORIGEMDATA...
        // Ex: "Polidor Avan√ßado1Santu√°rio da Uni√£o - Ba√∫..."
        // separamos em: [nome+quantidade] + [origem+data]
        const matchMain = line.match(/^(.*?)(\d+)(Santu√°rio da Uni√£o.*)$/);
        if (!matchMain) continue;

        const nomeBruto = matchMain[1].trim();
        const qtd = parseInt(matchMain[2], 10) || 0;
        const origemData = matchMain[3].trim();

        // origem = at√© come√ßar o ano 20xx
        const origemMatch = origemData.match(/^(.*?)(20\d{2}\.\d{2}\.\d{2}.*)$/);
        const origem = origemMatch ? origemMatch[1].trim() : origemData;

        if (!nomeBruto || !qtd) continue;

        const existing = repo.find(r =>
          r.item.toLowerCase() === nomeBruto.toLowerCase() &&
          r.boss === origem
        );
        if (existing) {
          existing.qtd += qtd;
        } else {
          repo.push({ item: nomeBruto, tipo: '', boss: origem, qtd });
        }
      }

      if (!repo.length) {
        showMessage('‚ùå N√£o consegui interpretar nenhum item', 'error');
        return;
      }

      state.repoItems[state.clan] = repo;
      saveState();
      renderRepo();
      fillDeliveryItemOptions();
      showMessage(`‚úÖ ${repo.length} itens carregados a partir do texto!`, 'success');
    }

    // Membros
    async function saveMember() {
      const idx = document.getElementById('member-index').value;
      const nick = document.getElementById('member-nick').value.trim();
      if (!nick) { showMessage('‚ùå Nick obrigat√≥rio', 'error'); return; }

      const levelStr = document.getElementById('member-level').value.trim();
      const powerStr = document.getElementById('member-power').value.trim();

      const record = {
        clan: state.clan,
        nick,
        level: levelStr ? parseInt(levelStr, 10) : null,
        power: powerStr ? parseInt(powerStr.replace(/\./g, ''), 10) : null,
        classe: document.getElementById('member-class').value,
        data: toISOFromBR(document.getElementById('member-date').value)
      };

      try {
        let saved;
        const currentList = state.members[state.clan] || [];

        if (idx !== '') {
          const existing = currentList[idx];
          if (!existing || !existing.id) {
            showMessage('‚ùå Registro sem id, recarregue a p√°gina', 'error');
            return;
          }
          const res = await fetch(`${API_BASE}/members/${existing.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record)
          });
          if (!res.ok) throw new Error('Erro ao atualizar membro');
          saved = await res.json();
          currentList[idx] = saved;
        } else {
          const res = await fetch(`${API_BASE}/members`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record)
          });
          if (!res.ok) throw new Error('Erro ao criar membro');
          saved = await res.json();
          currentList.push(saved);
        }

        state.members[state.clan] = currentList;
        closeModal('member-modal');
        renderMembers();
        fillEventNickOptions();
        fillDeliveryNickOptions();
        fillDeliveryItemOptions();
        showMessage('‚úÖ Salvo!', 'success');
      } catch (err) {
        console.error(err);
        showMessage('‚ùå Erro ao salvar membro na API', 'error');
      }
    }

    function openMemberModal(index = null) {
      document.getElementById('member-index').value = index !== null ? index : '';
      if (index !== null && index !== '') {
        const m = state.members[state.clan][index];
        document.getElementById('member-nick').value = m.nick;
        document.getElementById('member-level').value = m.level || '';
        document.getElementById('member-power').value = m.power != null ? Number(m.power).toLocaleString('pt-BR') : '';
        document.getElementById('member-class').value = m.classe || 'Arqueira';
        document.getElementById('member-date').value = toBRFromISO(m.data) || todayBR();
      } else {
        document.getElementById('member-nick').value = '';
        document.getElementById('member-level').value = '';
        document.getElementById('member-power').value = '';
        document.getElementById('member-class').value = 'Arqueira';
        document.getElementById('member-date').value = todayBR();
      }
      openModal('member-modal');
    }

    async function deleteMember(index) {
  const list = state.members[state.clan] || [];
  const item = list[index];
  if (!item) {
    showMessage('‚ùå Membro n√£o encontrado na lista', 'error');
    return;
  }

  if (!confirm(`Excluir membro ${item.nick}?`)) return;

  // se veio da API e tem id, tenta apagar na API
  if (item.id) {
    try {
      const res = await fetch(`${API_BASE}/members/${item.id}`, {
        method: 'DELETE'
      });
      if (!res.ok && res.status !== 204) {
        throw new Error('Erro ao excluir membro');
      }
    } catch (err) {
      console.error(err);
      showMessage('‚ùå Erro ao excluir membro na API (removido s√≥ localmente)', 'error');
      // mesmo com erro na API, segue removendo local
    }
  }

  // remove sempre do state/localStorage
  list.splice(index, 1);
  state.members[state.clan] = list;
  renderMembers();
  fillEventNickOptions();
  fillDeliveryNickOptions();
  fillDeliveryItemOptions();
  saveState();
  showMessage('‚úÖ Exclu√≠do!', 'success');
}


    async function clearAllMembers() {
      if (!confirm('Apagar TODOS os membros do cl√£ atual?')) return;

      try {
        const res = await fetch(`${API_BASE}/members?clan=${state.clan}`, {
          method: 'DELETE'
        });
        if (!res.ok && res.status !== 204) throw new Error('Erro ao apagar membros');

        state.members[state.clan] = [];
        renderMembers();
        fillEventNickOptions();
        fillDeliveryNickOptions();
        fillDeliveryItemOptions();
        showMessage('‚úÖ Apagado!', 'success');
      } catch (err) {
        console.error(err);
        showMessage('‚ùå Erro ao apagar membros na API', 'error');
      }
    }

    function renderMembers() {
  const body = document.getElementById('members-body');
  const all = state.members[state.clan] || [];

  const search = (document.getElementById('searchMembers')?.value || '').toLowerCase();
  const filterClass = document.getElementById('filterClass')?.value || '';

  // monta lista com √≠ndice REAL
  let list = all.map((m, idx) => ({ ...m, _idx: idx }));

  if (search) {
    list = list.filter(m => (m.nick || '').toLowerCase().includes(search));
  }
  if (filterClass) {
    list = list.filter(m => m.classe === filterClass);
  }

  // ordena s√≥ a vis√£o, mantendo _idx
  list.sort((a, b) => (a.nick || '').localeCompare(b.nick || '', 'pt-BR'));

  body.innerHTML = list.map(m => `
    <tr>
      <td>${m.nick}</td>
      <td>${m.level ?? ''}</td>
      <td>${m.power != null ? Number(m.power).toLocaleString('pt-BR') : ''}</td>
      <td>${m.classe ?? ''}</td>
      <td>${toBRDayMonthFromISO(m.data)}</td>
      <td>
        <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;"
                onclick="openMemberModal(${m._idx})">Editar</button>
        <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;"
                onclick="deleteMember(${m._idx})">Excluir</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="6">Nenhum</td></tr>';
}


    function fillEventNickOptions() {
      const select = document.getElementById('event-nick');
      if (select) {
        select.innerHTML = '<option>-- Selecione --</option>' + (state.members[state.clan] || [])
          .slice()
          .sort((a, b) => (a.nick || '').localeCompare(b.nick || '', 'pt-BR'))
          .map(m => `<option>${m.nick}</option>`).join('');
      }
    }

    function fillDeliveryNickOptions() {
      const select = document.getElementById('delivery-nick');
      if (select) {
        select.innerHTML = '<option>-- Selecione --</option>' +
          (state.members[state.clan] || [])
            .slice()
            .sort((a, b) => (a.nick || '').localeCompare(b.nick || '', 'pt-BR'))
            .map(m => `<option>${m.nick}</option>`)
            .join('');
      }
    }

    function fillDeliveryItemOptions() {
      const listEl = document.getElementById('delivery-items');
      if (!listEl) return;

      const items = (state.repoItems[state.clan] || [])
        .slice()
        .sort((a, b) => (a.item || '').localeCompare(b.item || '', 'pt-BR'));

      listEl.innerHTML = items
        .map(r => `<option value="${r.item}"></option>`)
        .join('');
    }

    // Eventos
    function openEventModal(index = null) {
      document.getElementById('event-index').value = index != null ? index : '';

      if (index != null && index !== '') {
        const e = state.events[state.clan][index];
        document.getElementById('event-date').value  = toBRFromISO(e.data);
        document.getElementById('event-name').value  = e.evento;
        document.getElementById('event-status').value = e.status;
        document.getElementById('event-just').value  = e.justificativa || '';
        fillEventNickOptions();
        document.getElementById('event-nick').value  = e.nick;
      } else {
        document.getElementById('event-date').value  = todayBR();
        document.getElementById('event-name').value  = 'Boss do cl√£';
        document.getElementById('event-status').value = 'Presente';
        document.getElementById('event-just').value  = '';
        fillEventNickOptions();
        document.getElementById('event-nick').value  = '';
      }

      openModal('event-modal');
    }

    function saveEvent() {
      const idx  = document.getElementById('event-index').value;
      const nick = document.getElementById('event-nick').value;
      if (!nick) {
        showMessage('‚ùå Nick obrigat√≥rio', 'error');
        return;
      }

      const record = {
        data:  toISOFromBR(document.getElementById('event-date').value),
        evento: document.getElementById('event-name').value,
        nick,
        status: document.getElementById('event-status').value,
        justificativa: document.getElementById('event-just').value
      };

      if (idx !== '') {
        state.events[state.clan][parseInt(idx, 10)] = record;
      } else {
        state.events[state.clan].push(record);
      }

      saveState();
      renderEvents();
      closeModal('event-modal');
      showMessage('‚úÖ Salvo!', 'success');
    }

    function deleteEvent(index) {
      state.events[state.clan].splice(index, 1);
      saveState();
      renderEvents();
      showMessage('‚úÖ Exclu√≠do!', 'success');
    }

    function clearAllEvents() {
      if (!confirm('Apagar TODOS os eventos?')) return;
      state.events[state.clan] = [];
      saveState();
      renderEvents();
      showMessage('‚úÖ Apagado!', 'success');
    }

    function renderEvents() {
      const body = document.getElementById('events-body');
      let list = [...(state.events[state.clan] || [])];

      const filterEvent = document.getElementById('filterEvent')?.value || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';

      if (filterEvent) list = list.filter(e => e.evento === filterEvent);
      if (filterStatus) list = list.filter(e => e.status === filterStatus);

      body.innerHTML = list.map((e, i) => `
        <tr>
          <td>${toBRDayMonthFromISO(e.data)}</td>
          <td>${e.nick}</td>
          <td>${e.evento}</td>
          <td>${e.status}</td>
          <td>${e.justificativa || ''}</td>
          <td>
            <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openEventModal(${i})">Editar</button>
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteEvent(${i})">Excluir</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6">Nenhum</td></tr>';
    }

    // Entregas
    function openDeliveryModal(index = null) {
      document.getElementById('delivery-index').value = index != null ? index : '';
      fillDeliveryNickOptions();
      fillDeliveryItemOptions();

      if (index != null && index !== '') {
        const d = state.deliveries[state.clan][index];
        document.getElementById('delivery-date').value  = toBRFromISO(d.data);
        document.getElementById('delivery-nick').value  = d.nick;
        document.getElementById('delivery-class').value = d.classe;
        document.getElementById('delivery-desc').value  = d.descricao;
        document.getElementById('delivery-qtd').value   = d.qtd || 1;
        document.getElementById('delivery-obs').value   = d.obs || '';
      } else {
        document.getElementById('delivery-date').value  = todayBR();
        document.getElementById('delivery-nick').value  = '';
        document.getElementById('delivery-class').value = 'Arqueira';
        document.getElementById('delivery-desc').value  = '';
        document.getElementById('delivery-qtd').value   = 1;
        document.getElementById('delivery-obs').value   = '';
      }

      openModal('delivery-modal');
    }

    function saveDelivery() {
      const idx   = document.getElementById('delivery-index').value;
      const date  = document.getElementById('delivery-date').value;
      const nick  = document.getElementById('delivery-nick').value;
      const classe = document.getElementById('delivery-class').value;
      const desc  = document.getElementById('delivery-desc').value.trim();
      const qtdStr = document.getElementById('delivery-qtd').value;
      const obs   = document.getElementById('delivery-obs').value.trim();

      if (!date || !nick || !desc || !qtdStr) {
        showMessage('‚ùå Data, Nick, Descri√ß√£o e Quantidade s√£o obrigat√≥rios', 'error');
        return;
      }

      const qtd = parseInt(qtdStr, 10);
      if (isNaN(qtd) || qtd <= 0) {
        showMessage('‚ùå Quantidade inv√°lida', 'error');
        return;
      }

      const record = {
        data: toISOFromBR(date),
        nick,
        classe,
        descricao: desc,
        qtd,
        obs
      };

      const repoList = state.repoItems[state.clan] || [];
      const repoIndex = repoList.findIndex(r => r.item === record.descricao);
      if (repoIndex !== -1) {
        repoList[repoIndex].qtd = (repoList[repoIndex].qtd || 0) - qtd;
        if (repoList[repoIndex].qtd <= 0) {
          repoList.splice(repoIndex, 1);
        }
        state.repoItems[state.clan] = repoList;
        renderRepo();
        fillDeliveryItemOptions();
      }

      if (idx !== '') {
        state.deliveries[state.clan][parseInt(idx, 10)] = record;
      } else {
        state.deliveries[state.clan].push(record);
      }

      saveState();
      closeModal('delivery-modal');
      renderDeliveries();
      showMessage('‚úÖ Salvo!', 'success');
    }

    function deleteDelivery(index) {
      if (!confirm('Excluir esta entrega?')) return;
      state.deliveries[state.clan].splice(index, 1);
      saveState();
      renderDeliveries();
      showMessage('‚úÖ Exclu√≠do!', 'success');
    }

    function renderDeliveries() {
      const body = document.getElementById('deliveries-body');
      let list = [...(state.deliveries[state.clan] || [])];

      const searchNick = (document.getElementById('searchDeliveriesNick')?.value || '').toLowerCase();
      const filterClass = document.getElementById('filterDeliveriesClass')?.value || '';

      if (searchNick) list = list.filter(d => (d.nick || '').toLowerCase().includes(searchNick));
      if (filterClass) list = list.filter(d => d.classe === filterClass);

      body.innerHTML = list.map((d, i) => `
        <tr>
          <td>${toBRDayMonthFromISO(d.data)}</td>
          <td>${d.nick}</td>
          <td>${d.classe}</td>
          <td>${d.descricao}</td>
          <td>${d.qtd || ''}</td>
          <td>
            <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="openDeliveryModal(${i})">Editar</button>
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deleteDelivery(${i})">Excluir</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6">Nenhuma entrega</td></tr>';
    }

    function showMonthlyReport() {
      const card = document.getElementById('monthly-report-card');
      card.style.display = card.style.display === 'none' ? 'block' : 'none';
      if (card.style.display === 'block') {
        renderMonthlyReport();
      }
    }

    function renderMonthlyReport() {
      const monthInput = document.getElementById('reportMonth').value;
      const body = document.getElementById('monthly-report-body');
      if (!monthInput) {
        body.innerHTML = '<tr><td colspan="2">Selecione um m√™s</td></tr>';
        return;
      }
      const [year, month] = monthInput.split('-');
      const deliveries = state.deliveries[state.clan] || [];
      const filtered = deliveries.filter(d => {
        if (!d.data) return false;
        const [y, m] = d.data.split('-');
        return y === year && m === month;
      });

      const byNick = {};
      filtered.forEach(d => {
        if (!byNick[d.nick]) byNick[d.nick] = [];
        byNick[d.nick].push(d);
      });

      const rows = Object.keys(byNick).sort().map(nick => {
        const resumo = byNick[nick].map(d => `${toBRDayMonthFromISO(d.data)} - ${d.descricao} (x${d.qtd || 1})`).join('<br>');
        return `<tr><td>${nick}</td><td>${resumo}</td></tr>`;
      });

      body.innerHTML = rows.join('') || '<tr><td colspan="2">Nenhuma entrega nesse m√™s</td></tr>';
    }

    // Reposit√≥rio
    function addRepoItem() {
      const item = document.getElementById('repoItem').value.trim();
      const tipo = document.getElementById('repoType').value.trim();
      const boss = document.getElementById('repoBoss').value.trim();
      const qtdStr  = document.getElementById('repoQuantity').value.trim();

      if (!item || !qtdStr) {
        showMessage('‚ùå Item e quantidade s√£o obrigat√≥rios!', 'error');
        return;
      }

      const qtd = parseInt(qtdStr, 10);
      if (isNaN(qtd) || qtd <= 0) {
        showMessage('‚ùå Quantidade inv√°lida!', 'error');
        return;
      }

      const repo = state.repoItems[state.clan] || [];
      const existingIndex = repo.findIndex(r => r.item.toLowerCase() === item.toLowerCase());
      if (existingIndex !== -1) {
        repo[existingIndex].qtd += qtd;
        if (tipo) repo[existingIndex].tipo = tipo;
        if (boss) repo[existingIndex].boss = boss;
      } else {
        repo.push({ item, tipo, boss, qtd });
      }
      state.repoItems[state.clan] = repo;
      saveState();
      renderRepo();
      fillDeliveryItemOptions();
      document.getElementById('repoItem').value = '';
      document.getElementById('repoType').value = '';
      document.getElementById('repoBoss').value = '';
      document.getElementById('repoQuantity').value = '';
      showMessage('‚úÖ Item salvo!', 'success');
    }

    function renderRepo() {
      const body = document.getElementById('repo-body');
      const repo = (state.repoItems[state.clan] || []).slice().sort((a, b) => (a.item || '').localeCompare(b.item || '', 'pt-BR'));
      body.innerHTML = repo.map((r, i) => `
        <tr>
          <td>${r.item}</td>
          <td>${r.tipo || ''}</td>
          <td>${r.boss || ''}</td>
          <td>${r.qtd}</td>
          <td>
            <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="removeRepoItem(${i})">Excluir</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="empty">Nenhum item</td></tr>';
    }

    function removeRepoItem(index) {
      if (!confirm('Excluir este item do reposit√≥rio?')) return;
      state.repoItems[state.clan].splice(index, 1);
      saveState();
      renderRepo();
      fillDeliveryItemOptions();
      showMessage('‚úÖ Item removido!', 'success');
    }

    function clearRepo() {
      if (!confirm('Limpar TODO o reposit√≥rio deste cl√£?')) return;
      state.repoItems[state.clan] = [];
      saveState();
      renderRepo();
      fillDeliveryItemOptions();
      showMessage('‚úÖ Reposit√≥rio limpo!', 'success');
    }

    function renderAll() {
      renderMembers();
      renderEvents();
      renderDeliveries();
      renderRepo();
      fillEventNickOptions();
      fillDeliveryNickOptions();
      fillDeliveryItemOptions();
    }

    window.onload = loadState;
  </script>
</body>
</html>
